{% block rendered_context %}
<|SECTION:CONTEXT|>
{%- with memory_query=query -%}
    {% include "extra-context.jinja2" %}
{% endwith -%}
{% set related_character = scene.parse_character_from_line(query) -%}
{% if related_character -%}
<|SECTION:{{ related_character.name|upper }}|>
{{ related_character.sheet}}
{% endif %}
<|CLOSE_SECTION|>
{% endblock %}
{% set scene_history=scene.context_history(budget=max_tokens-200-count_tokens(self.rendered_context()))  %}
{% set final_line_number=len(scene_history) %}
{% for scene_context in scene_history -%}
{{ loop.index }}. {{ scene_context }}
{% endfor %}
<|SECTION:TASK|>
{% if query.endswith("?") -%}
Instruction: Analyze Context, History and Dialogue and then answer the question: "{{ query }}". 
{% else -%}
Instruction: {{ query }}
{% endif %}
Prioritize story progression over strict adherence to context. Use your imagination to fill gaps, ensuring continuity with the established narrative.

Focus on advancing the scene, with the final lines carrying the most weight for future development. Consider the entire context, but emphasize forward momentum.

Address the query within the framework of line {{ final_line_number }}, maintaining the scene's natural progression.

Employ vivid, descriptive language to answer confidently and decisively. Avoid uncertainty, instead using sensory details and implied character thoughts to convey information.

Embody the role of an omniscient narrator, guiding the reader through the story world with your all-seeing perspective.

Maintain an informal, conversational tone reminiscent of 90s point-and-click adventure games. Your narration should feel natural, spontaneous, and immediate.

Question(s): {{ query }}
Content Context: This scene is set within {{ scene.context }}

Respond with concise narration (1-2 sentences) that fits the scene's context. Focus on descriptive prose and implied character experiences, avoiding direct speech or dialogue.

Remember: You are the narrator. Convey all information through your unique narrative voice.
{{ extra_instructions }}
{% include "rerun-context.jinja2" -%}
<|CLOSE_SECTION|>
{% if query.endswith("?") -%}Answer: {% endif -%}